---
hostname: m900-3
ssh_authorized_keys:
  - github:deekue
  - "ssh-ed25519
     AAAAC3NzaC1lZDI1NTE5AAAAIBIMWQez3DYo1jeHOOE3nG7RPllzzpKW2p2R7QwmOaoj
     apathy@chelone"
write_files:
  # yamllint disable-line rule:line-length
  - path: /root/provision.sh
    owner: root:root
    permissions: '0744'
    encoding: gz+base64
    content: |
      H4sICGaDz2ICA3Byb3Zpc2lvbi5zaAC9Vtty2zYQfRa/Yk07UdwxL1KcjqtYzjiOkxc39jhp++C6
      MxAJShiRAAOAsjWx/70LXiRQlJuOO9M3Alic3T1nd8HdnWDCeDAhaubsOrugZ0yBLLgCwYEuqFzC
      RAh9AEoApzRWoAVMKLCYZrnQlGtHUQ0eLQTkLKcJYanjpIJPZ0Ly3xT9YyZS+oGp+TghqaKro3Ir
      iOkiUDGxduU4WBAZpGwSNJtORM6o1GrsBlRHgVJpEJl1EBHPfLCERURT5UdSu46kU6a0XF5Jcb8c
      uzOt81EQDH4Z+oOfj/zD0H8zHL0eDI9cZ/5aXVfGjDbgkvBoRmWAZ4FcHfpLkqWug/xgskUOv1+c
      fgbGNZUJiahyzMkUadAzClEhJdICJrIDQLBoDiwBpvsKSCopiZd4VWmSpjQ20ZaBmgTH7t4rvJ2C
      lyhw91qJYK5levuug2A3N+DxymR124XbW3hrQuAOGI87MJU0B+/bXQLHr2boGLwhHB8fdy4+gEbZ
      wBvs41FNtrvGAqDRTIB7GseMT6HmbAklApydlqm6luEG/MmJBYtmCXOoKYXG3NQMjU1hSWroXtCn
      fMDJy6GD12sOdsCTCN3SsU1D5eBM8IRNC2nh5gbXBIOVg5x455cf4aSD5fQyJqWQauT0AGIRzan0
      mShXCM7jXGAV1EsADzZlc83RdBY949a3giyf4es5ruZHyn/GReSsFKMiueqM01+/Yo9IRlKIBFfY
      +65TlyFovfxyCGWbMc60JhN4eKgk6pdno5GkKid3fBQoM5WwpfQSvAsYDN4Mw7AGWOhBGPZNVdlQ
      27woiu1UYrT9rC+vLNpZxDicIBESLuoRtOq6CfLw3Z5hj52+QzPLxh6BaDseg6tlQdu3mns72xwM
      Nm2bsgYolGnIO4NfxbxxtZUDxEQTt0awyv4BciI1NmAnM6eXS6wC7IJ5SiY0hWleLow9dhDLCHYS
      vdeHEL4AFOVFVROVB2OEXTah5RrrBMOuur46+6JJNfJq7162hdoCxYVP76GMAxJJKfxZ4z9U460/
      Mrtv+5v73gL6oR+Gn95XBnu2RVTgk5UMwYtH612cgijMvmvpUQ7Z76toH59QwphxoTtyHGDavJyZ
      ZeRY2hH1fd+1GNpGO4a0lWR3bxWJW9G9jemmOmLBae2qJN90KsAuTjG4ozAjOGUJPvFZju1hEJhm
      gr9DkyaYK9z8XGTPlqgR4hw1Gt38Nbr9abRWodFgYGlgK2DzvxFQRwX7fLwZ4LbryMLXyw+XoIo8
      F8iyQChZkmA4AE4y1MwHOgW+yGjIB/nAet2wpzKijapt7Ee4Y3pWSlXRXnsRuUYR00pDs8C5+K40
      yOZ0iE+9t/gInq7Ocdg1mJ7pV+Q8hH+Rk91dHY0N8Eri5iekQ91/0bqttnHYUXy75v/Udz/S/f9U
      vuG2KYLz6+vL65HFqun/RBQ8DiKk1zCImz8ex+UfTQ18j+QOWg1rvQsbc0J22KjiysjcVGbMJGyY
      1xVnTry8A9b2136FrraNPvsHc4tx+bomyrzxW16uIo+rDlqbNUOxGd6dbC1EnI8n1trXWd6C34im
      14bqmfLscYFMYBAZPZA0LT8ghLAcvidPoGeLjX1rudZtJQVWw9YxsVEYK22MPXjEWtRN1aG3UstM
      9L8Bkxk0LcANAAA=
  # yamllint disable-line rule:line-length
  - path: /etc/network/interfaces
    owner: root:root
    permissions: '0644'
    encoding: gz+base64
    content: |
      H4sICAAAAAACA3N0ZGluAJWRUQ6CMBBE/znFnoC0QI0eZ4WqDVAa2mpIOLxbEERiFD4Im9mXmUwX
      vWugaiJ1wVzSAEpLR//GnDEvIwxr6W7sBYRxRGrUHqsIwBtQBiqlS7CkD4Q3nwssinEYthrr0Snm
      DMB1RsK9Qg2qgCD0PbjWy20O6doh3euQrR2yvQ6csXUL9t1heqChOOm/oXQLFLIW0Hww6rW4WWg5
      nM06dConLyrTSmuBn5KYH44ExCnJxNRoS0iEiKePkX5FJx/YLfFEZHMcf2fxP0FiX5AYg57T/qA2
      qAIAAA==
  # yamllint disable-line rule:line-length
  - path: /etc/mactab
    owner: root:root
    permissions: '0644'
    encoding: gz+base64
    content: |
      H4sICAAAAAACA3N0ZGluAEstyTBQMDCwMjK2MjKxSja3MjKyMk7kSi3JMAQJpxpYmSRbmVlYmaRa
      GZpxAQBoPLyGLgAAAA==
  # static DNS config
  - path: /etc/resolv.conf
    owner: root:root
    permissions: '0644'
    encoding: ""
    content: |-
      search home.chaosengine.net
      nameserver 192.168.40.254
  # persistent network device naming
  - path: /etc/network/if-pre-up.d/nameif
    owner: root:root
    permissions: '0644'
    encoding: ""
    content: |-
      #!/bin/sh
      /sbin/nameif -s
run_cmd:
  - "/root/provision.sh >> /root/provision.log 2>> /root/provision.err"
boot_cmd:
  # enable NFS client
  - mkdir -p /var/lib/nfs/sm
  - rc-update add rpc.statd
  - rc-update add nfsclient
  # use static network config rather than connman
  - rc-update add networking boot
  - rc-update del connman boot
k3os:
  modules:
    - kvm
    - nvme
  sysctl:
    kernel.printk: "4 4 1 7"
    kernel.kptr_restrict: "1"
  dns_nameservers:
    - 192.168.40.254
  ntp_servers:
    - 0.us.pool.ntp.org
    - 1.us.pool.ntp.org
  server_url: https://192.168.40.10:6443
  token: SECRETSQUIRREL
  password: "$1$ZDYMI7GJ$0F0YZRwBXP4l3CQItcXMg/"
  k3s_args:
    - server
    - "--tls-san"
    - "192.168.40.10"
    - "--tls-san"
    - "k8s.s.chaosengine.net"
    # replace with kube-vip LB
    - "--disable"
    - "servicelb"
    # replace with Cilium
    - "--flannel-backend=none"
    - "--disable-network-policy"
